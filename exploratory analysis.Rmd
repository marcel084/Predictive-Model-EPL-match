---
title: "Exploratory Analysis"
Author: Marcel Socorro
Class: Big Data Analytics Capstone
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
# Libraries
#install.packages("rvest")
library(rvest)
library(tidyverse)
library(purrr)
library(magrittr)
#library(plyr)
library(data.table)
```

```{r}
#Teams

# Get Resuts Table
url <- "https://fbref.com/en/comps/9/schedule/Premier-League-Fixtures"
epl2019 <- url %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_3232_1"]') %>%
  html_table()
epl2019 <- epl2019[[1]]
epl2019 <- epl2019[,-c(6,8)]
epl2019$Season<- 19
```
```{r}
# Get Resuts Table 2018-2019
url1 <- "https://fbref.com/en/comps/9/1889/schedule/2018-2019-Premier-League-Fixtures"
epl2018 <- url1 %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_1889_1"]') %>%
  html_table()
epl2018 <- epl2018[[1]]
epl2018 <- epl2018[,-c(6,8)]
epl2018$Season<- 18
```
```{r}
# Get Resuts Table 2017-2018
url2 <- "https://fbref.com/en/comps/9/1631/schedule/2017-2018-Premier-League-Fixtures"
epl2017 <- url2 %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_1631_1"]') %>%
  html_table()
epl2017 <- epl2017[[1]]
epl2017 <- epl2017[,-c(6,8)]
epl2017$Season<- 17
```
```{r}
# Get Resuts Table 2016-2017
url2016 <- "https://fbref.com/en/comps/9/1526/schedule/2016-2017-Premier-League-Fixtures"
epl2016 <- url2016 %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_1526_1"]') %>%
  html_table()
epl2016 <- epl2016[[1]]
epl2016$Season<- 16
```
```{r}
# Get Resuts Table 2015-2016
url2015 <- "https://fbref.com/en/comps/9/1467/schedule/2015-2016-Premier-League-Fixtures"
epl2015 <- url2015 %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_1467_1"]') %>%
  html_table()
epl2015 <- epl2015[[1]]
epl2015$Season<- 15
```
```{r}
# Get Resuts Table 2014-2015
url2014 <- "https://fbref.com/en/comps/9/733/schedule/2014-2015-Premier-League-Fixtures"
epl2014 <- url2014 %>%
  read_html() %>%
  html_nodes(xpath='//*[@id="sched_ks_733_1"]') %>%
  html_table()
epl2014 <- epl2014[[1]]
epl2014$Season<- 14
```


```{r}
epltotal<-rbind(epl2019,epl2018,epl2017,epl2016,epl2015,epl2014)
```



```{r}
epl2019$Date<- as.Date(epl2019$Date)
epl19 <- epl2019[ , !duplicated(colnames(epl2019))]
epl19 <- epl19 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl19$HomeGoals <- as.numeric(substr(epl19$Score,1,1))
epl19$AwayGoals <- as.numeric(substr(epl19$Score,3,3))
epl19$Result <- "D"
epl19$Result[epl19$HomeGoals > epl19$AwayGoals] <- "H"
epl19$Result[epl19$HomeGoals < epl19$AwayGoals] <- "A"
epl19$HomePoints <- 1
epl19$HomePoints[epl19$HomeGoals > epl19$AwayGoals] <- 3
epl19$HomePoints[epl19$HomeGoals < epl19$AwayGoals] <- 0
epl19$AwayPoints <- 1
epl19$AwayPoints[epl19$HomeGoals > epl19$AwayGoals] <- 0
epl19$AwayPoints[epl19$HomeGoals < epl19$AwayGoals] <- 3
epl19<-drop_na(epl19)
```
```{r}
epl2018$Date<- as.Date(epl2018$Date)
epl18 <- epl2018[ , !duplicated(colnames(epl2018))]
epl18 <- epl18 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl18$HomeGoals <- as.numeric(substr(epl18$Score,1,1))
epl18$AwayGoals <- as.numeric(substr(epl18$Score,3,3))
epl18$Result <- "D"
epl18$Result[epl18$HomeGoals > epl18$AwayGoals] <- "H"
epl18$Result[epl18$HomeGoals < epl18$AwayGoals] <- "A"
epl18$HomePoints <- 1
epl18$HomePoints[epl18$HomeGoals > epl18$AwayGoals] <- 3
epl18$HomePoints[epl18$HomeGoals < epl18$AwayGoals] <- 0
epl18$AwayPoints <- 1
epl18$AwayPoints[epl18$HomeGoals > epl18$AwayGoals] <- 0
epl18$AwayPoints[epl18$HomeGoals < epl18$AwayGoals] <- 3
epl18<-drop_na(epl18)
```
```{r}
epl2017$Date<- as.Date(epl2017$Date)
epl17 <- epl2017[ , !duplicated(colnames(epl2017))]
epl17 <- epl17 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl17$HomeGoals <- as.numeric(substr(epl17$Score,1,1))
epl17$AwayGoals <- as.numeric(substr(epl17$Score,3,3))
epl17$Result <- "D"
epl17$Result[epl17$HomeGoals > epl17$AwayGoals] <- "H"
epl17$Result[epl17$HomeGoals < epl17$AwayGoals] <- "A"
epl17$HomePoints <- 1
epl17$HomePoints[epl17$HomeGoals > epl17$AwayGoals] <- 3
epl17$HomePoints[epl17$HomeGoals < epl17$AwayGoals] <- 0
epl17$AwayPoints <- 1
epl17$AwayPoints[epl17$HomeGoals > epl17$AwayGoals] <- 0
epl17$AwayPoints[epl17$HomeGoals < epl17$AwayGoals] <- 3
epl17<-drop_na(epl17)
```
```{r}
epl2016$Date<- as.Date(epl2016$Date)
epl16 <- epl2016[ , !duplicated(colnames(epl2016))]
epl16 <- epl16 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl16$HomeGoals <- as.numeric(substr(epl16$Score,1,1))
epl16$AwayGoals <- as.numeric(substr(epl16$Score,3,3))
epl16$Result <- "D"
epl16$Result[epl16$HomeGoals > epl16$AwayGoals] <- "H"
epl16$Result[epl16$HomeGoals < epl16$AwayGoals] <- "A"
epl16$HomePoints <- 1
epl16$HomePoints[epl16$HomeGoals > epl16$AwayGoals] <- 3
epl16$HomePoints[epl16$HomeGoals < epl16$AwayGoals] <- 0
epl16$AwayPoints <- 1
epl16$AwayPoints[epl16$HomeGoals > epl16$AwayGoals] <- 0
epl16$AwayPoints[epl16$HomeGoals < epl16$AwayGoals] <- 3
epl16<-drop_na(epl16)
```
```{r}
epl2015$Date<- as.Date(epl2015$Date)
epl15 <- epl2015[ , !duplicated(colnames(epl2015))]
epl15 <- epl15 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl15$HomeGoals <- as.numeric(substr(epl15$Score,1,1))
epl15$AwayGoals <- as.numeric(substr(epl15$Score,3,3))
epl15$Result <- "D"
epl15$Result[epl15$HomeGoals > epl15$AwayGoals] <- "H"
epl15$Result[epl15$HomeGoals < epl15$AwayGoals] <- "A"
epl15$HomePoints <- 1
epl15$HomePoints[epl15$HomeGoals > epl15$AwayGoals] <- 3
epl15$HomePoints[epl15$HomeGoals < epl15$AwayGoals] <- 0
epl15$AwayPoints <- 1
epl15$AwayPoints[epl15$HomeGoals > epl15$AwayGoals] <- 0
epl15$AwayPoints[epl15$HomeGoals < epl15$AwayGoals] <- 3
epl15<-drop_na(epl15)
```
```{r}
epl2014$Date<- as.Date(epl2014$Date)
epl14 <- epl2014[ , !duplicated(colnames(epl2014))]
epl14 <- epl14 %>% filter(Date < Sys.Date()) %>% select(Season,Wk,Day,Date,Time,Home,Score,Away,Referee,Attendance)
epl14$HomeGoals <- as.numeric(substr(epl14$Score,1,1))
epl14$AwayGoals <- as.numeric(substr(epl14$Score,3,3))
epl14$Result <- "D"
epl14$Result[epl14$HomeGoals > epl14$AwayGoals] <- "H"
epl14$Result[epl14$HomeGoals < epl14$AwayGoals] <- "A"
epl14$HomePoints <- 1
epl14$HomePoints[epl14$HomeGoals > epl14$AwayGoals] <- 3
epl14$HomePoints[epl14$HomeGoals < epl14$AwayGoals] <- 0
epl14$AwayPoints <- 1
epl14$AwayPoints[epl14$HomeGoals > epl14$AwayGoals] <- 0
epl14$AwayPoints[epl14$HomeGoals < epl14$AwayGoals] <- 3
epl14<-drop_na(epl14)
```

```{r}
tableEPL<-function(x){
  acc <-
    data.frame(Season = factor(),
               Wk = integer(),
               Team = factor(),
               GF = integer(),
               GA = integer(),
               Points = integer(),
               HomeAway = factor(),
               Diff = integer(),
               CumPoints = integer(),
               CumDifGoal = integer (),
               CumAvgPoints = integer(),
               CumPointsHA = integer(),
               CumDifGoalHA = integer (),
               CumAvgPointsHA = integer())             
  for (i in 1: 38) {
    iDay<-subset(x,Wk=i)
    iHome<-iDay[,c(1,2,6,11,12,14)]
    iAway<-iDay[,c(1,2,8,12,11,15)]
    iHome$HomeAway<-"H"
    iAway$HomeAway<-"A"
      iHome<-iHome%>%
  rename(
    Team=Home,
    GF=HomeGoals,
    GA=AwayGoals,
    Points=HomePoints)
    iAway<-iAway%>%
  rename(
    Team=Away,
    GF=AwayGoals,
    GA=HomeGoals,
    Points=AwayPoints)
  acc<-rbind(iHome,iAway)
  acc$Diff<-acc$GF-acc$GA
  accOrd<-acc[order(acc$Team,acc$Wk),]
  accOrd<- data.frame(accOrd %>% group_by(Team) %>% 
  mutate(Cum_Points = cumsum(Points), CumDifGoal = cumsum(Diff), CumAvgPoints = cummean(Points) ))
  accOrd<- data.frame(accOrd %>% group_by(Team,HomeAway) %>% 
  mutate(Cum_PointsHA = cumsum(Points), CumDifGoalHA = cumsum(Diff), CumAvgPointsHA = cummean(Points) ))
  }
    return(accOrd)
}
```
```{r}
epl19T<-tableEPL(epl19)
epl18T<-tableEPL(epl18)
epl17T<-tableEPL(epl17)
epl16T<-tableEPL(epl16)
epl15T<-tableEPL(epl15)
epl14T<-tableEPL(epl14)
```
```{r}
eplCombined<-rbind(epl19T,epl18T,epl17T,epl16T,epl15T,epl14T)
```

```{r}
GroupByWeek<-group_by(eplCombined,Wk,HomeAway)
pointsByWeekHA<- summarize(GroupByWeek,
                           QtyPoints = sum(Points))
```
# 1st Graph
```{r}
p<-ggplot(pointsByWeekHA,aes(Wk,QtyPoints, color=HomeAway))+geom_point()+geom_line()+ labs(title= "Sum of points per week between Teams playing at home and away (last 6 seasons)",  x="Week", y = "Sum Quantity of Points")+ theme(plot.title = element_text(size=13))
p
```
In the graph above is plotted the sum of points obtained by teams playing at Home and Away every round for the last 6 seasons. The pattern is that teams playing at home are more likely to get more points that teams playing away except the first 4 round where this result is more chaotic. 
```{r}
GroupByWeekSeason<-group_by(eplCombined,Wk,HomeAway,Season)
pointsByWeekSeasonHA<- summarize(GroupByWeekSeason,
                           QtyPoints = sum(Points))
```
# 2nd Graph
```{r}
p<-ggplot(pointsByWeekSeasonHA,aes(Wk,QtyPoints, color=HomeAway))+geom_point()+geom_line()+ labs(title= "Points per week and season between Teams playing at home and away (last 6 seasons)",  x="Week", y = "Sum Quantity of Points")+ theme(plot.title = element_text(size=13))+facet_wrap(~Season)
p
```
This graph is used to have break down of the variables plotted in the first graph separated by each of the last 6 seasons. Same pattern could be generally observed, first round are more chaotics, but Home teams tend to get more points than teams playing away.

# 3rd Graph
```{r}
p<-ggplot(pointsByWeekHA, aes(QtyPoints, fill=HomeAway))+geom_histogram(alpha=0.7, position="identity", aes(y = ..density..), color="black") +
    geom_density(alpha=0.7) +
    geom_vline(aes(xintercept=mean(eval(parse(text=QtyPoints)))), color="black", linetype="dashed", size=1) +
    labs(title= "Histogram Sum of points per week between Teams playing at home and away (last 6 seasons)",  x="Points", y = "Density")+ theme(plot.title = element_text(size=11.5))
     
p
```
This is a Histogram for the variable Sum of Quantity of points for the last 6 season separated by each round and playing home/away team.In this graph is observed the two curves displaced from the general mean, the mean of the curve Home team is displaced to the right and the mean of the curve Away team is displaced to the left.   
```{r}
shapiro.test(pointsByWeekHA$QtyPoints)
```
Shapiro test is run for the variable Sum of Quantity of points by week and pvalue is higher than 0.05 which means that null hipothesys (The variable is normally distributed) can't be rejected.
```{r}
pointsByWeekH<-subset(pointsByWeekHA,HomeAway=="H")
pointsByWeekA<-subset(pointsByWeekHA,HomeAway=="A")
t.test(pointsByWeekH$QtyPoints,pointsByWeekA$QtyPoints,paired=TRUE)
```
Once it is proved that the variable is normally distributed, it is confirmed that there is a significant difference between the Sum of quantity of points obtained by teams playing at home and away each week. Pvalue is less than 0.05, which means that there is enough evidence to reject null hypothesis (No significant differences between both variables). It could be confirmed that playing at home or away, it's a factor impacting the outcome of the game.The test was done setting the parameter paired=TRUE because both variable are not independent of each other.
```{r}
lastDateUpTo18<-subset(eplCombined,Wk==38 & Season<=18)
lastDate19<-subset(eplCombined, Wk==29 & Season == 19)
lastDate<-rbind(lastDate19,lastDateUpTo18)
lastDate$Season<-as.numeric(lastDate$Season)
lastDate[order(-lastDate$Season,-lastDate$Cum_Points),]
```
# 4th Graph
```{r}
p<-ggplot(lastDate,aes(CumDifGoal,Cum_Points))+geom_point()+geom_smooth(method="lm",se=FALSE)+labs(title="Cummulative Goal Difference vs Points per Team (last date of last 6 seasons)", x= "Goal Difference per Team", y="Points per Team")
p
```
The graph above is a subset of the last round for each of the last 6 seasons. The cummulative variables throughout each season, goal difference and points per team are plotted.According the graph there is a strong positive correlation between these 2 variables. 

# 5th Graph
## Getting the optimum cluster
```{r}
set.seed(20)
places<-data.frame(CumPoints=lastDate$Cum_Points,lastDate$CumDifGoal)
wss<-numeric(15)
for (k in 1:15)
  wss[k]=sum(kmeans(places, k,nstart=25)$withinss)
wssResults<-data.frame(k=c(1:15),wss=wss)
wssResults
plot(wssResults$k,wssResults$wss)
```
According to wss vs k analysis, the optimal cluster is chosen for 2 units, the big drop happens in the second cluster, and from the third cluster, the drop in the wss is less than the half of the previous cluster, for instance the wss linked to the 3rd cluster represents the 62% of the wss linked to the 2nd cluster which represents a drop of 38%. This selection is done assuming a big drop for a difference greater than 50%. This criteria could be reevaluated for chosing 4 clusters to test the model.     
```{r}
placesCluster<-kmeans(places,2,nstart=25)
placesCluster
```
# 6th Graph
```{r}
#Add the cluster assignment to each point
lastDate$Cluster<-as.factor(placesCluster$cluster)
#Get Centroids
centroids<-as.data.frame(placesCluster$centers)
centroids$Cluster<-as.factor(c(1:2))
#Visualize cluster assignments
ggplot(data=lastDate,aes(CumDifGoal,Cum_Points,color=Cluster))+geom_point()+geom_point(data=centroids,aes(x=lastDate.CumDifGoal,y=CumPoints,fill=Cluster),size=5,shape=13)+labs(title="Cummulative Goal Difference vs Points per Team (last date of last 6 seasons)",x= "Goal Difference per Team", y="Points per Team")
```
In the graph above each point (Team) is assigned to a cluster, this could be an element to group teams with similar performance, and then getting metrics from this.
```{r}
byCluster<-group_by(lastDate,Cluster)
byClusterAvg<-summarize(byCluster,
                        avgGF=mean(GF),
                        avgGA=mean(GA))
byClusterAvgGF<-byClusterAvg[,c(1,2)]%>%
  rename(
    avgGoals=avgGF)
byClusterAvgGF$Goal<-"GF"
byClusterAvgGA<-byClusterAvg[,c(1,3)]%>%
  rename(
    avgGoals=avgGA)
byClusterAvgGA$Goal<-"GA"
byClusterAnalysis<-rbind(byClusterAvgGF,byClusterAvgGA)
```
# 7th Graph
```{r}
byClusterAnalysis$avgGoals>-as.numeric(byClusterAnalysis$avgGoals)
byClusterAnalysis$avgGoals <- round(byClusterAnalysis$avgGoals, digits = 2)
p<-ggplot(byClusterAnalysis, aes(Goal,avgGoals, fill=Goal))+geom_bar(position="dodge",stat="identity") + geom_text(aes(label = avgGoals),size = 3, hjust = 0.5, vjust = 3, position =     "stack")+labs(title = "Comparison GF vs GA by cluster last date games(6 Seasons)", x="Goals for and Goals against", y="Goal Average")+facet_wrap(~Cluster)
p
```
Using the cluster assigned it was compared the goals for and against for each group, the differce is remarkable between them.
```{r}
Home<-subset(eplCombined,HomeAway=="H")
bySeasonResult<-group_by(Home,Season,Points)
TableSeasonResult<-summarize(bySeasonResult,
                             count=n())%>%  # count records by species
 mutate(pct = count/sum(count))
TableSeasonResult
```

```{r}
QtyResultsHome<-c(nrow(subset(eplCombined,Points==3&HomeAway=="H")),nrow(subset(eplCombined,Points==0&HomeAway=="H")),nrow(subset(eplCombined,Points==1&HomeAway=="H")))
resultsHome<-c("Victory","Defeat","Draw")
homePerf<-data.frame("Quantity" = QtyResultsHome, "Result"= resultsHome)
```
# 8th Graph
```{r}
p<-ggplot(homePerf, aes(Result,Quantity, fill=Result))+geom_bar(position="dodge",stat="identity") + geom_text(aes(label = Quantity),size = 3, hjust = 0.5, vjust = 3, position =     "stack")+labs(title = "Performance EPL teams playing at home stadium (last 6 seasons)",x="Result", y="Quantity")
p
```
Analyzing the graph based on general probabilities, could be seen the proportion for the performance of all teams playing at home during the last 6 seasons. We could see that the outcome less likely is the draw, and the outcome most likely is the victory. For the teams playing away will be the same results only switching classes between defeats and victories, the outcome most likely for a team playing away is the defeat.

# 9th graph
```{r}
TableSeasonResult$Points<-as.factor(TableSeasonResult$Points)
p<-ggplot(TableSeasonResult, aes(Points,count, fill=Points))+geom_bar(stat="identity") + geom_text(aes(label=scales::percent(pct)), position = position_stack(vjust = .5),size = 2)  +labs(title = "Performance EPL teams playing at home stadium per Season",x="Result", y="Quantity")+facet_grid(~Season)
p
```
This graph is a breakdown of the previous graph, it could be seen that probabilities of a win for a team playing at home oscilated between 41.3% and 49.2% for the last 6 seasons. 
```{r}

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


